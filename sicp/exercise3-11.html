<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <title>SICP</title>
  <meta name="description" content="Junsong's blog">
  <meta name="author" content="Junsong Li">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">

  <link href="/assets/normalize.css" rel="stylesheet" type="text/css">
  <link href="/assets/skeleton.css" rel="stylesheet" type="text/css">
  <link href="/assets/main.css" rel="stylesheet" type="text/css">
  <link href="/assets/template282.css" rel="stylesheet" type="text/css">
  <link href="/sicp/sicp.css" rel="stylesheet" type="text/css">

  <script src="/assets/simple-jquery.js"></script>
  <script src="/assets/dropdown.js"></script>

  <link rel="icon" type="image/png" href="images/favicon.png">
</head>
<body>

  <div class="container book-header">
    <h2 class="book-title"> SICP 全笔记 </h1>
    <nav>
      <ul class="book-navbar">
        <li><a href="/sicp/index.html">目录</a></li>
        <li><a href="/sicp/about.html">关于</a></li>
      </ul>
    </nav>

  </div>

  <div class="container page">
    <div class="row">
      <div class="offset-by-two eight columns">
        <div class="content">
          <div class="exerciseQ"><p>Exercise 3.11.  In section 3.2.3 we saw how the environment model described the behavior of procedures with local state. Now we have seen how internal definitions work. A typical message-passing procedure contains both of these aspects. Consider the bank account procedure of section 3.1.1:</p><pre class="gist"><code>(define (make-account balance)
  (define (withdraw amount)
    (if (&gt;= balance amount)
        (begin (set! balance (- balance amount))
               balance)
        "Insufficient funds"))
  (define (deposit amount)
    (set! balance (+ balance amount))
    balance)
  (define (dispatch m)
    (cond ((eq? m 'withdraw) withdraw)
          ((eq? m 'deposit) deposit)
          (else (error "Unknown request -- MAKE-ACCOUNT"
                       m))))
  dispatch)
</code></pre><p> Show the environment structure generated by the sequence of interactions</p><pre class="gist"><code>(define acc (make-account 50))

((acc 'deposit) 40)
90

((acc 'withdraw) 60)
30
</code></pre><p> Where is the local state for acc kept? Suppose we define another account</p><pre class="gist"><code>(define acc2 (make-account 100))
</code></pre><p> How are the local states for the two accounts kept distinct? Which parts of the environment structure are shared between acc and acc2?</p></div><p> 首先是定义 make-account：</p><pre class="gist"><code>+-------------------------------+
| make-account: ---+            |
|                  |            |
+------------------+------------+
                   |
                   |
                   |
                   |
                   |
                   v
   Parameter: balance
        body: (define (withdraw..))
              (define (deposit..))
              (define (dispatch..))
              dispatch</code></pre><p>然后是定义 acc，</p><pre class="gist"><code>+-------------------------------------------------------------+
| make-account: ...                                           |
| acc ----+                                                   |
+---------+---------------------------------------------------+
          |                           ^
          |                           |
          |             E1            |
          |                +----------+---------+
          |                | withdraw:...       |
          |  +------------&gt;| deposit:...        |
          |  |             | dispatch:...       |
          v  |             | balance: 50        |
  Parameter: m             +--------------------+
      body: ...</code></pre><p>运行 ((acc ‘deposit) 40)</p><pre class="gist"><code>+-------------------------------------------------------------+
| make-account: ...                                           |
| acc ----+                                                   |
+---------+---------------------------------------------------+
          |                           ^
          |                           |
          |             E1            |
          |                +----------+---------+
          |                | withdraw:...       |     (set! balance (+ balance amount))
          |  +------------&gt;| deposit:...        | &lt;-----------------+
          |  |             | dispatch:...       |                   |
          v  |             | balance: 50 (--&gt;90)|                   |
  Parameter: m             +--------------------+                   |
      body: ...                            ^             E3         |
                               E2          |                +-------+-----+
                                    +------+-------+        | amount: 40  |
                                    | m: 'deposit  |        +-------------+
                                    +--------------+
                                     (acc 'deposit)</code></pre><p>得到结果 balance 将从 50 变为 90。</p><p>下一步是 <code>((acc 'withdraw) 60)</code>，它将首先绑定 dispatch 的 m，然后绑定 withdraw 的 amount 到 60，最后改变 <span class="vsymbol v">balance</span></p><pre class="gist"><code>+-------------------------------------------------------------+
| make-account: ...                                           |
| acc ----+                                                   |
+---------+---------------------------------------------------+
          |                           ^
          |                           |
          |             E1            |
          |                +----------+---------+
          |                | withdraw:...       |       (begin (set! balance...))
          |  +------------&gt;| deposit:...        |&lt;---------------+
          |  |             | dispatch:...       |                |
          v  |             | balance: 90(--&gt;30) |                |
  Parameter: m             +--------------------+                |
      body: ...                            ^                     |
                                E4         |                     |
                                    +------+------+   E5  +------+---------+
                                    | m:'with-draw|       | amount: 60     |
                                    +-------------+       +----------------+</code></pre><p>可以看出 acc 的局部状态保存在 E1 中。当我们另外定义一个 <span class="vlong v">(define acc2 (make-account 100))</span> 的时候，acc2 的环境将会创建一个 E6，这个 E6 将与 E1 的初始状态一样。 acc 与 acc2 共享的部分只会是代码，两者的环境是各自独立的。</p>
        </div>
      </div>
    </div>

  </div>

</body>
</html>